-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  broker text,
  account_type text CHECK (account_type = ANY (ARRAY['live'::text, 'demo'::text, 'paper'::text])),
  initial_balance numeric NOT NULL DEFAULT 0 CHECK (initial_balance >= 0::numeric),
  current_balance numeric NOT NULL DEFAULT 0,
  profit_loss numeric DEFAULT (current_balance - initial_balance),
  currency text DEFAULT 'USD'::text,
  is_active boolean DEFAULT true,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  commission numeric DEFAULT 0,
  fees numeric DEFAULT 0,
  CONSTRAINT accounts_pkey PRIMARY KEY (id),
  CONSTRAINT accounts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.affiliate_commissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  affiliate_user_id uuid NOT NULL,
  referred_user_id uuid NOT NULL,
  subscription_id uuid,
  payment_id uuid,
  commission_amount numeric NOT NULL,
  commission_percentage numeric NOT NULL,
  payment_amount numeric NOT NULL,
  currency text DEFAULT 'INR'::text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'paid'::text, 'cancelled'::text])),
  paid_at timestamp with time zone,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT affiliate_commissions_pkey PRIMARY KEY (id),
  CONSTRAINT affiliate_commissions_affiliate_user_id_fkey FOREIGN KEY (affiliate_user_id) REFERENCES public.app_users(id),
  CONSTRAINT affiliate_commissions_referred_user_id_fkey FOREIGN KEY (referred_user_id) REFERENCES public.app_users(id),
  CONSTRAINT affiliate_commissions_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.user_subscriptions(id),
  CONSTRAINT affiliate_commissions_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payment_history(id)
);
CREATE TABLE public.app_users (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  username text NOT NULL UNIQUE,
  first_name text,
  last_name text,
  full_name text DEFAULT 
CASE
    WHEN ((first_name IS NOT NULL) AND (last_name IS NOT NULL)) THEN ((first_name || ' '::text) || last_name)
    WHEN (first_name IS NOT NULL) THEN first_name
    WHEN (last_name IS NOT NULL) THEN last_name
    ELSE username
END,
  display_name text,
  avatar_url text,
  user_role text DEFAULT 'user'::text CHECK (user_role = ANY (ARRAY['user'::text, 'admin'::text, 'moderator'::text])),
  subscription_status text DEFAULT 'trialing'::text CHECK (subscription_status = ANY (ARRAY['trialing'::text, 'active'::text, 'expired'::text, 'cancelled'::text, 'past_due'::text])),
  trial_end_date timestamp with time zone DEFAULT (now() + '7 days'::interval),
  onboarding_completed boolean DEFAULT false,
  profile_completed boolean DEFAULT false,
  email_verified boolean DEFAULT false,
  signup_source text,
  is_active boolean DEFAULT true,
  affiliate_code text UNIQUE,
  referred_by text,
  last_login_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT app_users_pkey PRIMARY KEY (id),
  CONSTRAINT app_users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.chats (
  chat_id uuid NOT NULL DEFAULT gen_random_uuid(),
  participant1_id uuid NOT NULL,
  participant2_id uuid NOT NULL,
  last_message text,
  last_message_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chats_pkey PRIMARY KEY (chat_id),
  CONSTRAINT chats_participant1_id_fkey FOREIGN KEY (participant1_id) REFERENCES public.app_users(id),
  CONSTRAINT chats_participant2_id_fkey FOREIGN KEY (participant2_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.commissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid,
  broker text,
  market_type text CHECK (market_type = ANY (ARRAY['stocks'::text, 'forex'::text, 'crypto'::text, 'futures'::text, 'options'::text, 'commodities'::text])),
  commission_type text NOT NULL CHECK (commission_type = ANY (ARRAY['per_trade'::text, 'per_share'::text, 'percentage'::text, 'tiered'::text])),
  commission_value numeric NOT NULL CHECK (commission_value >= 0::numeric),
  minimum_commission numeric,
  maximum_commission numeric,
  currency text DEFAULT 'USD'::text,
  notes text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  commission numeric,
  fees numeric,
  total_fees numeric DEFAULT (COALESCE(commission, (0)::numeric) + COALESCE(fees, (0)::numeric)),
  CONSTRAINT commissions_pkey PRIMARY KEY (id),
  CONSTRAINT commissions_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT commissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.community_follows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT community_follows_pkey PRIMARY KEY (id),
  CONSTRAINT community_follows_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES public.app_users(id),
  CONSTRAINT community_follows_following_id_fkey FOREIGN KEY (following_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.coupon_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  coupon_id uuid NOT NULL,
  user_id uuid NOT NULL,
  subscription_id uuid,
  payment_id uuid,
  discount_amount numeric NOT NULL,
  used_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupon_usage_pkey PRIMARY KEY (id),
  CONSTRAINT coupon_usage_coupon_id_fkey FOREIGN KEY (coupon_id) REFERENCES public.coupons(id),
  CONSTRAINT coupon_usage_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT coupon_usage_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.user_subscriptions(id),
  CONSTRAINT coupon_usage_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payment_history(id)
);
CREATE TABLE public.coupons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  name text NOT NULL,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percentage'::text, 'fixed'::text])),
  discount_value numeric NOT NULL,
  currency text DEFAULT 'USD'::text,
  valid_from timestamp with time zone NOT NULL DEFAULT now(),
  valid_until timestamp with time zone NOT NULL,
  usage_limit_total integer,
  usage_limit_per_user integer DEFAULT 1,
  usage_count integer DEFAULT 0,
  applicable_plans ARRAY,
  currency_restriction ARRAY,
  is_active boolean DEFAULT true,
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupons_pkey PRIMARY KEY (id),
  CONSTRAINT coupons_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.app_users(id)
);
CREATE TABLE public.email_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  email_type text NOT NULL,
  recipient_email text NOT NULL,
  subject text,
  status text NOT NULL CHECK (status = ANY (ARRAY['queued'::text, 'sent'::text, 'delivered'::text, 'opened'::text, 'clicked'::text, 'bounced'::text, 'failed'::text, 'spam'::text])),
  provider text DEFAULT 'brevo'::text,
  provider_message_id text,
  template_id text,
  template_data jsonb DEFAULT '{}'::jsonb,
  error_message text,
  metadata jsonb DEFAULT '{}'::jsonb,
  sent_at timestamp with time zone,
  delivered_at timestamp with time zone,
  opened_at timestamp with time zone,
  clicked_at timestamp with time zone,
  bounced_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT email_logs_pkey PRIMARY KEY (id),
  CONSTRAINT email_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.email_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  email_type text NOT NULL,
  recipient_email text NOT NULL,
  subject text NOT NULL,
  email_data jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'sent'::text, 'failed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  sent_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  CONSTRAINT email_queue_pkey PRIMARY KEY (id),
  CONSTRAINT email_queue_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.error_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  function_name text NOT NULL,
  user_id uuid,
  error_message text NOT NULL,
  error_stack text,
  context jsonb,
  occurred_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT error_logs_pkey PRIMARY KEY (id),
  CONSTRAINT error_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.function_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  function_name text NOT NULL,
  user_id uuid,
  duration_ms integer NOT NULL,
  success boolean NOT NULL DEFAULT true,
  error_message text,
  metadata jsonb,
  called_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT function_logs_pkey PRIMARY KEY (id),
  CONSTRAINT function_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.journal (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  journal_date date NOT NULL,
  title text,
  content text,
  mood text CHECK (mood = ANY (ARRAY['excellent'::text, 'good'::text, 'neutral'::text, 'bad'::text, 'terrible'::text])),
  market_conditions text,
  lessons_learned text,
  goals_for_tomorrow text,
  tags ARRAY,
  is_pinned boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT journal_pkey PRIMARY KEY (id),
  CONSTRAINT journal_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.journal_images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  journal_id uuid NOT NULL,
  user_id uuid NOT NULL,
  image_url text NOT NULL,
  image_name text,
  caption text,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  notes text,
  linked_trade_id uuid,
  CONSTRAINT journal_images_pkey PRIMARY KEY (id),
  CONSTRAINT journal_images_linked_trade_id_fkey FOREIGN KEY (linked_trade_id) REFERENCES public.trades(id),
  CONSTRAINT journal_images_journal_id_fkey FOREIGN KEY (journal_id) REFERENCES public.journal(id),
  CONSTRAINT journal_images_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  chat_id uuid NOT NULL,
  sender_id uuid NOT NULL,
  content text NOT NULL,
  status text DEFAULT 'sent'::text CHECK (status = ANY (ARRAY['sent'::text, 'delivered'::text, 'read'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT messages_pkey PRIMARY KEY (id),
  CONSTRAINT messages_chat_id_fkey FOREIGN KEY (chat_id) REFERENCES public.chats(chat_id),
  CONSTRAINT messages_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  title text NOT NULL CHECK (length(TRIM(BOTH FROM title)) > 0),
  content text,
  category text,
  tags ARRAY,
  is_pinned boolean DEFAULT false,
  is_archived boolean DEFAULT false,
  color text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notes_pkey PRIMARY KEY (id),
  CONSTRAINT notes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  type text NOT NULL,
  title text NOT NULL,
  message text,
  action_type text CHECK (action_type = ANY (ARRAY['navigate'::text, 'external_link'::text, 'none'::text])),
  action_url text,
  data jsonb DEFAULT '{}'::jsonb,
  is_read boolean DEFAULT false,
  read_at timestamp with time zone,
  priority text DEFAULT 'normal'::text CHECK (priority = ANY (ARRAY['low'::text, 'normal'::text, 'high'::text, 'urgent'::text])),
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.partial_exits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid NOT NULL,
  user_id uuid NOT NULL,
  exit_quantity numeric NOT NULL CHECK (exit_quantity > 0::numeric),
  exit_price numeric NOT NULL CHECK (exit_price > 0::numeric),
  exit_time timestamp with time zone NOT NULL,
  fees numeric DEFAULT 0,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partial_exits_pkey PRIMARY KEY (id),
  CONSTRAINT partial_exits_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id),
  CONSTRAINT partial_exits_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.payment_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  subscription_id uuid,
  amount numeric NOT NULL,
  original_amount numeric,
  discount_amount numeric DEFAULT 0,
  currency text DEFAULT 'USD'::text,
  status text NOT NULL CHECK (status = ANY (ARRAY['pending'::text, 'succeeded'::text, 'failed'::text, 'refunded'::text, 'cancelled'::text])),
  payment_method text,
  payment_gateway text CHECK (payment_gateway = ANY (ARRAY['cashfree'::text, 'stripe'::text, 'manual'::text])),
  gateway_payment_id text,
  gateway_order_id text,
  transaction_id text,
  invoice_id text,
  order_number text,
  description text,
  coupon_code text,
  provider_ref text,
  admin_notes text,
  cashfree_order_id text,
  cashfree_payment_session_id text,
  metadata jsonb DEFAULT '{}'::jsonb,
  paid_at timestamp with time zone,
  refunded_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_history_pkey PRIMARY KEY (id),
  CONSTRAINT payment_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT payment_history_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.user_subscriptions(id)
);
CREATE TABLE public.pinned_trades (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  trade_id uuid NOT NULL,
  pin_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pinned_trades_pkey PRIMARY KEY (id),
  CONSTRAINT pinned_trades_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT pinned_trades_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id)
);
CREATE TABLE public.rate_limit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  endpoint text NOT NULL,
  ip_address text,
  exceeded_at timestamp with time zone NOT NULL DEFAULT now(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT rate_limit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT rate_limit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.strategies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  description text,
  rules jsonb DEFAULT '[]'::jsonb,
  image_url text,
  is_active boolean DEFAULT true,
  is_public boolean DEFAULT false,
  total_trades integer DEFAULT 0,
  winning_trades integer DEFAULT 0,
  losing_trades integer DEFAULT 0,
  win_rate numeric DEFAULT 0,
  total_pnl numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  notes text,
  is_shared boolean DEFAULT false,
  shared_at timestamp with time zone,
  shared_by_user_id uuid,
  losses integer DEFAULT 0,
  net_pl numeric DEFAULT 0,
  CONSTRAINT strategies_pkey PRIMARY KEY (id),
  CONSTRAINT strategies_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT strategies_shared_by_user_id_fkey FOREIGN KEY (shared_by_user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.strategy_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  strategy_id uuid NOT NULL,
  user_id uuid NOT NULL,
  rule_type text NOT NULL CHECK (rule_type = ANY (ARRAY['entry'::text, 'exit'::text, 'risk_management'::text, 'position_sizing'::text, 'general'::text])),
  rule_title text NOT NULL,
  rule_description text,
  rule_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT strategy_rules_pkey PRIMARY KEY (id),
  CONSTRAINT strategy_rules_strategy_id_fkey FOREIGN KEY (strategy_id) REFERENCES public.strategies(id),
  CONSTRAINT strategy_rules_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.subscription_event_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  subscription_id uuid,
  event_type text NOT NULL,
  old_status text,
  new_status text,
  metadata jsonb DEFAULT '{}'::jsonb,
  performed_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscription_event_logs_pkey PRIMARY KEY (id),
  CONSTRAINT subscription_event_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT subscription_event_logs_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.user_subscriptions(id),
  CONSTRAINT subscription_event_logs_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.app_users(id)
);
CREATE TABLE public.subscription_plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  display_name text NOT NULL,
  description text,
  plan_type text DEFAULT 'paid'::text CHECK (plan_type = ANY (ARRAY['trial'::text, 'paid'::text, 'lifetime'::text])),
  validity_days integer,
  price_monthly numeric,
  price_yearly numeric,
  currency text DEFAULT 'USD'::text,
  features jsonb NOT NULL DEFAULT '{}'::jsonb,
  limits jsonb NOT NULL DEFAULT '{"accounts": 1, "strategies": 3, "trades_per_month": 100}'::jsonb,
  is_active boolean DEFAULT true,
  is_default boolean DEFAULT false,
  sort_order integer DEFAULT 0,
  stripe_price_id_monthly text,
  stripe_price_id_yearly text,
  cashfree_plan_id_monthly text,
  cashfree_plan_id_yearly text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscription_plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  name text NOT NULL,
  tag_type text CHECK (tag_type = ANY (ARRAY['trade'::text, 'mistake'::text, 'setup'::text, 'custom'::text])),
  color text,
  description text,
  usage_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  linked_trades text,
  linked_strategies text,
  CONSTRAINT tags_pkey PRIMARY KEY (id),
  CONSTRAINT tags_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.trade_comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  trade_id uuid NOT NULL,
  parent_comment_id uuid,
  content text NOT NULL CHECK (length(TRIM(BOTH FROM content)) > 0),
  is_edited boolean DEFAULT false,
  edited_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_comments_pkey PRIMARY KEY (id),
  CONSTRAINT trade_comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT trade_comments_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id),
  CONSTRAINT trade_comments_parent_comment_id_fkey FOREIGN KEY (parent_comment_id) REFERENCES public.trade_comments(id)
);
CREATE TABLE public.trade_images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid NOT NULL,
  user_id uuid NOT NULL,
  image_url text NOT NULL,
  image_name text,
  image_type text CHECK (image_type = ANY (ARRAY['chart'::text, 'screenshot'::text, 'analysis'::text, 'other'::text])),
  display_order integer DEFAULT 0,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_images_pkey PRIMARY KEY (id),
  CONSTRAINT trade_images_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT trade_images_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id)
);
CREATE TABLE public.trade_likes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  trade_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_likes_pkey PRIMARY KEY (id),
  CONSTRAINT trade_likes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT trade_likes_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id)
);
CREATE TABLE public.trade_metrics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid NOT NULL UNIQUE,
  user_id uuid NOT NULL,
  gross_pnl numeric,
  net_pnl numeric,
  percent_gain numeric,
  r_multiple numeric,
  risk_amount numeric,
  reward_amount numeric,
  risk_reward_ratio numeric,
  trade_duration interval,
  trade_duration_minutes integer,
  trade_result text CHECK (trade_result = ANY (ARRAY['win'::text, 'loss'::text, 'breakeven'::text])),
  max_drawdown numeric,
  max_profit numeric,
  mae numeric,
  mfe numeric,
  calculated_at timestamp with time zone DEFAULT now(),
  net_p_and_l numeric DEFAULT net_pnl,
  gross_p_and_l numeric DEFAULT gross_pnl,
  pnl numeric DEFAULT net_pnl,
  r2r numeric DEFAULT r_multiple,
  trade_outcome text DEFAULT trade_result,
  CONSTRAINT trade_metrics_pkey PRIMARY KEY (id),
  CONSTRAINT trade_metrics_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id),
  CONSTRAINT trade_metrics_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.trade_tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid NOT NULL,
  tag_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_tags_pkey PRIMARY KEY (id),
  CONSTRAINT trade_tags_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(id),
  CONSTRAINT trade_tags_tag_id_fkey FOREIGN KEY (tag_id) REFERENCES public.tags(id)
);
CREATE TABLE public.trader_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  bio text,
  about_content text,
  trading_experience text CHECK (trading_experience = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'advanced'::text, 'professional'::text])),
  risk_tolerance text CHECK (risk_tolerance = ANY (ARRAY['conservative'::text, 'moderate'::text, 'aggressive'::text])),
  preferred_markets ARRAY,
  location text,
  timezone text DEFAULT 'UTC'::text,
  website_url text,
  social_links jsonb DEFAULT '{}'::jsonb,
  profile_data jsonb DEFAULT '{}'::jsonb,
  stats_visibility jsonb DEFAULT '{"show_pnl": true, "show_trades": true, "show_win_rate": true}'::jsonb,
  privacy_settings jsonb DEFAULT '{"trades_visible": false, "profile_visible": true}'::jsonb,
  is_public boolean DEFAULT true,
  total_trades integer DEFAULT 0,
  win_rate numeric DEFAULT 0,
  total_pnl numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trader_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT trader_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.trades (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  account_id uuid,
  strategy_id uuid,
  instrument text NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['long'::text, 'short'::text, 'buy'::text, 'sell'::text])),
  market_type text,
  entry_price numeric NOT NULL CHECK (entry_price > 0::numeric),
  quantity numeric NOT NULL CHECK (quantity > 0::numeric),
  entry_time timestamp with time zone NOT NULL,
  exit_price numeric CHECK (exit_price IS NULL OR exit_price > 0::numeric),
  exit_time timestamp with time zone,
  remaining_quantity numeric,
  status text DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'partially_closed'::text, 'closed'::text, 'cancelled'::text])),
  sl numeric,
  target numeric,
  commission numeric DEFAULT 0,
  fees numeric DEFAULT 0,
  notes text,
  rating integer CHECK (rating >= 1 AND rating <= 5),
  trade_time_frame text,
  chart_link text,
  trade_date date,
  is_shared boolean DEFAULT false,
  shared_at timestamp with time zone,
  shared_by_user_id uuid,
  main_image text,
  contract text,
  contract_multiplier numeric,
  tick_size numeric,
  tick_value numeric,
  parent_trade_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  trade_rating integer CHECK (trade_rating IS NULL OR trade_rating >= 1 AND trade_rating <= 5),
  total_exit_quantity numeric DEFAULT 0,
  partial_exits jsonb,
  tags jsonb,
  additional_images jsonb,
  CONSTRAINT trades_pkey PRIMARY KEY (id),
  CONSTRAINT trades_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT trades_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id),
  CONSTRAINT trades_strategy_id_fkey FOREIGN KEY (strategy_id) REFERENCES public.strategies(id),
  CONSTRAINT trades_shared_by_user_id_fkey FOREIGN KEY (shared_by_user_id) REFERENCES public.app_users(id),
  CONSTRAINT trades_parent_trade_id_fkey FOREIGN KEY (parent_trade_id) REFERENCES public.trades(id)
);
CREATE TABLE public.user_creation_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  auth_user_id uuid,
  email text NOT NULL,
  signup_method text CHECK (signup_method = ANY (ARRAY['email'::text, 'google'::text, 'github'::text, 'apple'::text])),
  signup_source text,
  ip_address inet,
  user_agent text,
  referrer text,
  utm_source text,
  utm_medium text,
  utm_campaign text,
  profile_created boolean DEFAULT false,
  profile_creation_attempts integer DEFAULT 0,
  profile_creation_error text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_creation_log_pkey PRIMARY KEY (id),
  CONSTRAINT user_creation_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.user_push_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  token text NOT NULL,
  platform text NOT NULL CHECK (platform = ANY (ARRAY['web'::text, 'ios'::text, 'android'::text])),
  device_info jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  last_used_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_push_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT user_push_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.user_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  key text NOT NULL,
  value jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_settings_pkey PRIMARY KEY (id),
  CONSTRAINT user_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id)
);
CREATE TABLE public.user_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  plan_id uuid NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['trialing'::text, 'active'::text, 'expired'::text, 'cancelled'::text, 'past_due'::text])),
  billing_cycle text CHECK (billing_cycle = ANY (ARRAY['monthly'::text, 'yearly'::text, 'lifetime'::text])),
  current_period_start timestamp with time zone NOT NULL,
  current_period_end timestamp with time zone NOT NULL,
  next_billing_date timestamp with time zone,
  cancel_at_period_end boolean DEFAULT false,
  cancelled_at timestamp with time zone,
  payment_gateway text CHECK (payment_gateway = ANY (ARRAY['cashfree'::text, 'stripe'::text, 'manual'::text, 'trial'::text])),
  gateway_subscription_id text,
  gateway_customer_id text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT user_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.app_users(id),
  CONSTRAINT user_subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.subscription_plans(id)
);