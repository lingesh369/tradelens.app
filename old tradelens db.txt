-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.accounts (
  account_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_name character varying NOT NULL,
  broker character varying,
  type character varying DEFAULT 'live'::character varying,
  starting_balance numeric DEFAULT 0,
  current_balance numeric DEFAULT 0,
  profit_loss numeric,
  commission numeric,
  fees numeric,
  status character varying DEFAULT 'active'::character varying,
  created_on timestamp with time zone DEFAULT now(),
  CONSTRAINT accounts_pkey PRIMARY KEY (account_id)
);
CREATE TABLE public.app_users (
  user_id uuid NOT NULL,
  email text NOT NULL,
  username text UNIQUE,
  first_name text,
  last_name text,
  display_name text,
  profile_completed boolean DEFAULT false,
  email_verified boolean DEFAULT false,
  signup_source text DEFAULT 'direct'::text,
  last_login_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  user_role character varying DEFAULT 'user'::character varying CHECK (user_role::text = ANY (ARRAY['user'::character varying::text, 'admin'::character varying::text, 'manager'::character varying::text])),
  CONSTRAINT app_users_pkey PRIMARY KEY (user_id),
  CONSTRAINT app_users_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT app_users_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.commissions (
  commission_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  account_id uuid,
  broker character varying,
  commission numeric NOT NULL,
  fees numeric NOT NULL,
  market_type character varying NOT NULL,
  total_fees numeric NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT commissions_pkey PRIMARY KEY (commission_id),
  CONSTRAINT commissions_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(account_id)
);
CREATE TABLE public.community_follows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  follower_id uuid,
  following_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT community_follows_pkey PRIMARY KEY (id)
);
CREATE TABLE public.coupon_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  coupon_id uuid,
  user_id uuid,
  payment_id uuid,
  discount_applied numeric NOT NULL,
  used_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupon_usage_pkey PRIMARY KEY (id),
  CONSTRAINT coupon_usage_coupon_id_fkey FOREIGN KEY (coupon_id) REFERENCES public.coupons(id),
  CONSTRAINT coupon_usage_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(payment_id)
);
CREATE TABLE public.coupons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  discount_type character varying NOT NULL CHECK (discount_type::text = ANY (ARRAY['percentage'::character varying, 'fixed'::character varying]::text[])),
  discount_value numeric NOT NULL,
  applicable_plans jsonb,
  currency_restriction character varying,
  usage_limit_total integer,
  usage_limit_per_user integer,
  used_count integer DEFAULT 0,
  validity_start_date timestamp with time zone,
  validity_end_date timestamp with time zone,
  status character varying DEFAULT 'active'::character varying,
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupons_pkey PRIMARY KEY (id)
);
CREATE TABLE public.email_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  email character varying NOT NULL,
  response_id integer,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  email_type character varying,
  template_id integer,
  status character varying DEFAULT 'pending'::character varying,
  CONSTRAINT email_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.email_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  email_type text NOT NULL,
  recipient_email text NOT NULL,
  subject text NOT NULL,
  email_data jsonb NOT NULL DEFAULT '{}'::jsonb,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text, 'cancelled'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  sent_at timestamp with time zone,
  error_message text,
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  CONSTRAINT email_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.journal (
  journal_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  journal_date date NOT NULL,
  notes text,
  net_pl numeric,
  num_trades integer,
  win_rate numeric,
  profit_factor numeric,
  total_profitable_pl numeric,
  total_losing_pl numeric,
  winning_trades integer,
  losing_trades integer,
  total_fees numeric,
  image_captions jsonb,
  all_trades_notes text,
  all_journal_images_notes text,
  trades_executed text,
  CONSTRAINT journal_pkey PRIMARY KEY (journal_id)
);
CREATE TABLE public.journal_images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  journal_date date NOT NULL,
  image_name character varying NOT NULL,
  image_url text NOT NULL,
  linked_trade_id uuid,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT journal_images_pkey PRIMARY KEY (id),
  CONSTRAINT journal_images_linked_trade_id_fkey FOREIGN KEY (linked_trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.notes (
  note_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  title character varying,
  content text,
  preview text,
  date date,
  tags ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notes_pkey PRIMARY KEY (note_id)
);
CREATE TABLE public.notification_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  notification_id uuid,
  scheduled_notification_id uuid,
  delivery_channel character varying NOT NULL,
  delivery_status character varying,
  delivered_at timestamp with time zone,
  read_at timestamp with time zone,
  clicked_at timestamp with time zone,
  error_message text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notification_logs_pkey PRIMARY KEY (id),
  CONSTRAINT notification_logs_notification_id_fkey FOREIGN KEY (notification_id) REFERENCES public.notifications(id),
  CONSTRAINT notification_logs_scheduled_notification_id_fkey FOREIGN KEY (scheduled_notification_id) REFERENCES public.scheduled_notifications(id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  title character varying NOT NULL,
  message text NOT NULL,
  type character varying NOT NULL,
  status character varying DEFAULT 'unread'::character varying,
  is_read boolean DEFAULT false,
  action_type character varying,
  link text,
  trade_id uuid,
  comment_id uuid,
  source_user_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id),
  CONSTRAINT notifications_comment_id_fkey FOREIGN KEY (comment_id) REFERENCES public.trade_comments(id)
);
CREATE TABLE public.partial_exits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid,
  user_id uuid,
  exit_quantity numeric NOT NULL,
  exit_price numeric NOT NULL,
  exit_time timestamp with time zone NOT NULL,
  fees numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT partial_exits_pkey PRIMARY KEY (id),
  CONSTRAINT partial_exits_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.payments (
  payment_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  amount numeric NOT NULL,
  currency character varying DEFAULT 'USD'::character varying,
  payment_status character varying DEFAULT 'pending'::character varying,
  payment_method character varying,
  payment_date timestamp with time zone DEFAULT now(),
  description text,
  subscription_plan character varying,
  plan_id uuid,
  billing_cycle character varying CHECK (billing_cycle::text = ANY (ARRAY['monthly'::character varying, 'yearly'::character varying]::text[])),
  transaction_id character varying,
  invoice_id character varying,
  order_number character varying,
  original_amount numeric,
  discount_applied numeric,
  coupon_code character varying,
  coupon_id uuid,
  provider_ref character varying,
  admin_notes text,
  created_at timestamp with time zone DEFAULT now(),
  cashfree_order_id character varying,
  cashfree_payment_session_id character varying,
  CONSTRAINT payments_pkey PRIMARY KEY (payment_id),
  CONSTRAINT payments_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.subscription_plans(plan_id),
  CONSTRAINT payments_coupon_id_fkey FOREIGN KEY (coupon_id) REFERENCES public.coupons(id)
);
CREATE TABLE public.pinned_trades (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  trade_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pinned_trades_pkey PRIMARY KEY (id),
  CONSTRAINT pinned_trades_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.scheduled_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  created_by uuid,
  target_type character varying NOT NULL,
  target_user_ids ARRAY,
  notification_data jsonb NOT NULL,
  scheduled_for timestamp with time zone NOT NULL,
  repeat_type character varying,
  status character varying DEFAULT 'pending'::character varying,
  timezone character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT scheduled_notifications_pkey PRIMARY KEY (id)
);
CREATE TABLE public.settings (
  setting_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  base_currency character varying DEFAULT 'USD'::character varying,
  time_zone character varying,
  subscription_status character varying,
  accounts_linked integer,
  custom_tags text,
  mistakes_tags text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT settings_pkey PRIMARY KEY (setting_id)
);
CREATE TABLE public.strategies (
  strategy_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  strategy_name character varying NOT NULL,
  description text,
  notes text,
  is_public boolean DEFAULT false,
  is_shared boolean DEFAULT false,
  shared_at timestamp with time zone,
  shared_by_user_id uuid,
  total_trades integer,
  wins integer,
  losses integer,
  net_pl numeric,
  win_rate numeric,
  CONSTRAINT strategies_pkey PRIMARY KEY (strategy_id)
);
CREATE TABLE public.strategy_rules (
  rule_id uuid NOT NULL DEFAULT gen_random_uuid(),
  strategy_id uuid,
  user_id uuid,
  rule_title character varying NOT NULL,
  rule_description text,
  rule_type character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT strategy_rules_pkey PRIMARY KEY (rule_id),
  CONSTRAINT strategy_rules_strategy_id_fkey FOREIGN KEY (strategy_id) REFERENCES public.strategies(strategy_id)
);
CREATE TABLE public.subscription_plans (
  plan_id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL UNIQUE,
  validity_days integer,
  notes_access boolean,
  analytics_overview_access boolean,
  analytics_other_access boolean,
  trading_account_limit integer,
  trading_strategy_limit integer,
  profile_access boolean,
  price_monthly numeric,
  price_yearly numeric,
  features jsonb,
  limits jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  plan_type character varying DEFAULT 'trial'::character varying CHECK (plan_type::text = ANY (ARRAY['trial'::character varying, 'basic'::character varying, 'premium'::character varying, 'enterprise'::character varying]::text[])),
  is_default boolean DEFAULT false,
  CONSTRAINT subscription_plans_pkey PRIMARY KEY (plan_id)
);
CREATE TABLE public.tags (
  tag_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  tag_name character varying NOT NULL,
  tag_type character varying,
  description text,
  linked_trades text,
  linked_strategies text,
  CONSTRAINT tags_pkey PRIMARY KEY (tag_id)
);
CREATE TABLE public.trade_comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  trade_id uuid,
  comment_text text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_comments_pkey PRIMARY KEY (id),
  CONSTRAINT trade_comments_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.trade_images (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid NOT NULL,
  user_id uuid NOT NULL,
  image_url text NOT NULL,
  image_name text NOT NULL,
  image_type character varying DEFAULT 'additional'::character varying CHECK (image_type::text = ANY (ARRAY['main'::character varying, 'additional'::character varying]::text[])),
  display_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_images_pkey PRIMARY KEY (id),
  CONSTRAINT trade_images_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.trade_likes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  trade_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trade_likes_pkey PRIMARY KEY (id),
  CONSTRAINT trade_likes_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.trade_metrics (
  metric_id uuid NOT NULL DEFAULT gen_random_uuid(),
  trade_id uuid UNIQUE,
  user_id uuid,
  fees numeric,
  swap numeric,
  trade_duration interval,
  trade_outcome character varying,
  percent_gain numeric,
  total_pnl numeric,
  average_trade_pnl numeric,
  average_win numeric,
  average_loss numeric,
  win_rate numeric,
  loss_rate numeric,
  break_even_rate numeric,
  largest_win numeric,
  largest_loss numeric,
  average_hold_time interval,
  average_hold_win interval,
  average_hold_loss interval,
  max_consecutive_wins integer,
  max_consecutive_losses integer,
  profit_factor numeric,
  largest_profit_day numeric,
  largest_loss_day numeric,
  expected_profitability numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  net_p_and_l numeric,
  gross_p_and_l numeric,
  r2r numeric,
  total_fees numeric,
  pnl numeric,
  r_multiple numeric,
  CONSTRAINT trade_metrics_pkey PRIMARY KEY (metric_id),
  CONSTRAINT trade_metrics_trade_id_fkey FOREIGN KEY (trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.trader_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  is_public boolean DEFAULT false,
  bio text,
  about_content jsonb,
  profile_data jsonb,
  social_links jsonb,
  stats_visibility jsonb,
  privacy_settings jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trader_profiles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.trades (
  trade_id uuid NOT NULL DEFAULT gen_random_uuid(),
  account_id uuid,
  instrument character varying NOT NULL,
  action character varying NOT NULL CHECK (action::text = ANY (ARRAY['buy'::character varying, 'sell'::character varying]::text[])),
  entry_price numeric NOT NULL,
  exit_price numeric,
  quantity numeric NOT NULL,
  entry_time timestamp with time zone,
  exit_time timestamp with time zone,
  market_type character varying,
  chart_link text,
  sl numeric,
  target numeric,
  rating integer,
  notes text,
  commission numeric,
  fees numeric,
  strategy_id uuid,
  contract character varying,
  trade_time_frame character varying,
  contract_multiplier numeric,
  tick_size numeric,
  tick_value numeric,
  trade_rating integer,
  remaining_quantity numeric,
  parent_trade_id uuid,
  status character varying DEFAULT 'open'::character varying CHECK (status::text = ANY (ARRAY['open'::character varying, 'partially_closed'::character varying, 'closed'::character varying]::text[])),
  total_exit_quantity numeric,
  partial_exits jsonb,
  tags jsonb,
  main_image text,
  additional_images jsonb,
  is_shared boolean DEFAULT false,
  shared_at timestamp with time zone,
  shared_by_user_id uuid,
  trade_date date,
  created_at timestamp with time zone DEFAULT now(),
  user_id uuid NOT NULL,
  CONSTRAINT trades_pkey PRIMARY KEY (trade_id),
  CONSTRAINT trades_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(account_id),
  CONSTRAINT trades_strategy_id_fkey FOREIGN KEY (strategy_id) REFERENCES public.strategies(strategy_id),
  CONSTRAINT trades_parent_trade_id_fkey FOREIGN KEY (parent_trade_id) REFERENCES public.trades(trade_id)
);
CREATE TABLE public.trading_rules (
  rule_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  rule_type character varying NOT NULL,
  rule_value text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trading_rules_pkey PRIMARY KEY (rule_id)
);
CREATE TABLE public.trial_email_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  email_type character varying NOT NULL,
  trial_end_date date NOT NULL,
  email_sent_at timestamp with time zone DEFAULT now(),
  email_status character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT trial_email_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_activity_tracking (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  activity_type text NOT NULL,
  activity_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_activity_tracking_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_push_tokens (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  subscription_data jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_push_tokens_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  settings_type character varying NOT NULL,
  settings_data jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_subscriptions_new (
  subscription_id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  plan_id uuid NOT NULL,
  status character varying DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'expired'::character varying, 'trialing'::character varying, 'cancelled'::character varying]::text[])),
  start_date timestamp with time zone DEFAULT now(),
  end_date timestamp with time zone,
  billing_cycle character varying CHECK (billing_cycle::text = ANY (ARRAY['monthly'::character varying, 'yearly'::character varying, '-'::character varying]::text[])),
  next_billing_date timestamp with time zone,
  payment_method character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  email character varying,
  plan_name character varying,
  CONSTRAINT user_subscriptions_new_pkey PRIMARY KEY (subscription_id),
  CONSTRAINT user_subscriptions_new_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.subscription_plans(plan_id)
);
CREATE TABLE public.welcome_emails (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  email_address text NOT NULL,
  sent_at timestamp with time zone,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text])),
  error_message text,
  retry_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT welcome_emails_pkey PRIMARY KEY (id)
);